{"version":3,"sources":["transplants/transforms.cljc"],"mappings":";AAMA,AA2BA,kCAAA,lCAAMA,4EAAUC,EAAEC;AAAlB,AACE,oDAAA,7CAACC,gFAAQ,AAACC,4CAAI,WAAAC;AAAA,AAAA,IAAAC,aAAAD;QAAA,AAAAE,4CAAAD,WAAA,IAAA,/DAAME;QAAN,AAAAD,4CAAAD,WAAA,IAAA,/DAAQG;AAAR,AAAA,0FAAaD,EAAE,CAACP,kCAAAA,qCAAAA,LAAEQ,iBAAAA;GAAKP;;AAEvC,AAAA;;;;;;sCAAA,8CAAAQ,pFAAME;AAAN,AAAA,IAAAD,WAAA,AAAA;AAAA,AAAA,QAAAA;KAAA;AAAA,OAAAC,kEAAA,CAAA,UAAA;;;KAAA;AAAA,OAAAA,kEAAA,CAAA,UAAA,MAAA,CAAA,UAAA;;;;AAAA,MAAA,KAAAC,MAAA,CAAA,8DAAA,AAAA;;;;;AAAA,CAAA,oEAAA,pEAAMD,+EAKFE;AALJ,AAMG,yEAAA,lEAACC,uEAAiBD;;;AANrB,CAAA,oEAAA,pEAAMF,+EAOFI,IAAIF;AAPR,AAQG,IAAME,UAAI,EAAI,OAASA,kBAAK,AAACC,oBAAKD,KAAKA;IACjCF,SAAG,EAAI,OAASA,iBAAI,AAACG,oBAAKH,IAAIA;AADpC,AAEE,oBAAI,iBAAAI,oBAAKJ;AAAL,AAAA,oBAAAI;AAAA,SAAQ,OAASJ,yBAAI,yCAAA,zCAACK,kCAAaL;;AAAnCI;;;AACF,OAACE,gDAAQJ,QAAI,oDAAA,pDAACK,6CAAKP;;AACnBA;;;;AAZP,CAAA,8DAAA,9DAAMF;;AAAN,AAcA,AAUA,AA8BA","names":["transplants.transforms/map-vals","f","m","cljs.core.into","cljs.core.map","p__81456","vec__81461","cljs.core.nth","k","v","var_args","G__81473","transplants.transforms/unstring-key","js/Error","ks","transplants.transforms.unstring_key","nsp","clojure.string/trim","and__4251__auto__","clojure.string/starts-with?","cljs.core.keyword","cljs.core.subs"],"sourcesContent":["(ns transplants.transforms\n  \"db value transforms\"\n  (:require  [winton-utils.data-frame :refer [map-of-vs->v-of-maps]]\n             [clojure.string :refer [starts-with? trim]]\n             [clojure.pprint :refer [pprint]]))\n\n(comment\n  ; problem1:\n  ; \n  ; Transform an inputs sheet into a set of widget input maps\n  (def widget-inputs-map\n    \"Example of a widget-inputs-map\"\n    {:factor-key [:kidney :sex]\n     :levels [{:level :male\n               :label \"Male\"}\n              {:level :female\n               :label \"Female\"}]\n     :default :male})\n  ;\n  ; problem2: We need to register subscriptions on the fly. However different tools overlap in their factor requirements and this\n  ; can mean that the same factor is registered multiple times on the same organ. We assume that if factors have the same name, then\n  ; they are in clinical practice the same (if not, change their name!), and so it is OK to use just the one at run-time for all tools \n  ; that refer to it.\n  ; \n  ; re-frame default behaviour is to warn if a subsscription or event has been previously registered on a key. \n  ; That's OK - the warning is useful. In production the warning can be ignored as the most recent registration prevails. \n  ;\n  ; What's not so helpful is that the old subscription is not removed when the new one is created so there is a possible small \n  ; memory leak each time the configuration is read in (unless garbage collection can handle it). However, since we only \n  ; read configuration once at startup, the leak is bounded.\n  ; \n  )\n\n(defn map-vals [f m]\n  (into {} (map (fn [[k v]] [k (f v)]) m)))\n\n(defn unstring-key\n  \"ks is a string starting with a colon. Convert it to a true keyword.\n   Useful when processing ':keyword' values readin from a spreadsheet into true keywords.\n   \n   Single arity returns a global key. Double arity returns a namespaced key\"\n  ([ks]\n   (unstring-key nil ks))\n  ([nsp ks]\n   (let [nsp (if (string? nsp) (trim nsp) nsp)\n         ks (if (string? ks) (trim ks) ks)]\n     (if (and ks (string? ks) (starts-with? ks \":\"))\n       (keyword nsp (subs ks 1)) \n       ks))))\n\n(comment\n  (unstring-key \":hello\")\n  ;; => :hello\n\n  (unstring-key \":foo/bar\")\n  (unstring-key \" :foo/bar \")\n    ;; => \" :foo/bar \"\n  0)\n  ;=> :hello)\n\n(comment\n  (def inputs\n    {:beta-transplant '(0 -0.06289 nil 0.60387 0.46442 0.26097 0 -0.28334 -0.77722 nil 0 -0.01539 nil 0 0.54305 0.00727 0.54305 nil 0 -0.28893 -0.61033 nil 0 -0.35381 nil 0 0.29132 nil 0 -0.74768 nil 0 -0.32635 nil nil nil nil nil nil nil nil nil nil)\n     :beta-death '(0 -0.10852 nil -1.43819 -1.04978 -0.57859 0 0.09774 0.13967 nil 0 -0.26636 nil 0 -0.19369 0.03454 -0.19369 nil 0 0.09036 0.14314 nil 0 0.46463 nil 0 -0.50041 nil 0 0.33496 nil 0.86605 0 nil nil nil nil nil nil nil nil nil nil)\n     :info-box? '(\"Male\" \"Female\" nil nil nil nil nil nil nil nil :yes nil nil nil nil nil nil nil :yes nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil)\n     :beta-removal '(0 0.01097 nil -0.99622 -0.75824 -0.43028 0 0.66553 1.56677 nil 0 -0.13979 nil 0 -0.19443 -0.03596 -0.19443 nil 0 0.09631 0.2109 nil 0 -0.10169 nil 0 -0.31226 nil 0 0.32677 nil 0.18723 0 nil nil nil nil nil nil nil nil nil nil)\n     :level-name '(\"Male\" \"Female\" nil \"18 - 29\"  \"30 - 39\" \"40 - 49\" \"50 - 59\" \"60 - 69\" \"70 +\" nil \"White\" \"Non-white\" nil \"O\" \"A\" \"B\" \"AB\" nil \"easy\" \"moderate\" \"difficult\" nil \"first\" \"re-graft\" nil \"Yes\" \"No\" nil \"No\" \"Yes\" nil \"No\" \"Yes\" nil nil nil nil nil nil nil nil nil nil)\n     :beta-all-reasons '(0 -0.10876 nil 0.3303 0.22041 0.09241 0 -0.03388 0.11484 nil 0 -0.09953 nil 0 0.57296 0.00578 0.57296 nil 0 -0.29547 -0.62205 nil 0 -0.32497 nil 0 0.11702 nil 0 -0.56793 nil 0 0.05058 nil nil nil nil nil nil nil nil nil nil)\n     :type '(:radio nil nil :dropdown nil nil nil nil nil nil :radio nil nil :radio nil nil nil nil :dropdown nil nil nil :radio nil nil :radio nil nil :radio nil nil :radio nil nil nil nil nil nil nil nil nil nil nil)\n     :sub-text '(\"Sex\" nil nil \"Age (years)\" nil nil nil nil nil nil nil nil nil nil nil nil nil nil \"match score 1-3\" \"match score 4-6\" \"match score 7-10\" nil \"No previous graft\" \"Replacing previous graft\" nil nil nil nil \"cRF less than 85%\" \"cRF 85% or more\" nil nil \"?\" nil nil nil nil nil nil nil nil nil nil)\n     :level '(:male :female nil :18+ :30+ :40+ :50+ :60+ :70+ nil :white :non-white nil :O :A :B :AB nil :easy :moderate :difficult nil :first :re-graft nil :yes :no nil :no :yes nil :no :yes nil nil nil nil nil nil nil nil nil nil)\n     :factor '(:sex :sex nil :age :age :age :age :age :age nil :ethnicity :ethnicity nil :blood-group :blood-group :blood-group :blood-group nil :matchability :matchability :matchability nil :graft :graft nil :dialysis :dialysis nil :sensitised :sensitised nil :diabetes :diabetes nil nil nil nil nil nil nil nil nil nil)\n     :order '(1 1 nil 1.2 1.2 1.2 1.2 1.2 1.2 nil 1.3 1.3 nil 1.4 1.4 1.4 1.4 nil 1.5 1.5 1.5 nil 1.6 1.6 nil 1.7 1.7 nil 1.8 1.8 nil 1.9 1.9 nil nil nil nil nil nil nil nil nil nil)\n     :factor-name '(\"Sex\" nil nil \"Age (years)\" nil nil nil nil nil nil \"Ethnicity\" nil nil \"Blood group\" nil nil nil nil \"Matchability group\" nil nil nil \"Graft number\" nil nil \"Dialysis at registration?\" nil nil \"Highly sensitised?\" nil nil \"Primary renal disease - diabetes?\" nil nil nil nil nil nil nil nil nil nil nil)}\n    )\n\n  (pprint (->> inputs\n               (map-of-vs->v-of-maps)\n               ;(filter #(= (:factor %) :sex)\n               ))\n  \n  (pprint (->> inputs\n               (map-of-vs->v-of-maps)\n               (filter #(keyword? (:factor %)))\n               (map #(map-vals unstring-key %))\n               (partition-by :factor)\n               (sort-by (comp :order first))))\n  )\n\n\n(comment\n  (map-vals #(* 2 %) {:A 1 :B 3})\n\n  \n  (unstring-key nil)\n\n  (def tool-inputs {:beta-transplant '(nil nil 0 -0.06289 nil 0.60387 0.46442 0.26097 0 -0.28334 -0.77722 nil 0 -0.01539 nil 0 0.54305 0.00727 0.54305 nil 0 -0.28893 -0.61033 nil 0 -0.35381 nil 0 0.29132 nil 0 -0.74768 nil 0 -0.32635 nil nil nil nil nil)\n                    :beta-death '(nil nil 0 -0.10852 nil -1.43819 -1.04978 -0.57859 0 0.09774 0.13967 nil 0 -0.26636 nil 0 -0.19369 0.03454 -0.19369 nil 0 0.09036 0.14314 nil 0 0.46463 nil 0 -0.50041 nil 0 0.33496 nil 0.86605 0 nil nil nil nil nil)\n                    :info-box? '(nil nil \"Male\" \"Female\" nil nil nil nil nil nil nil nil :yes nil nil nil nil nil nil nil :yes nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil)\n                    :beta-removal '(nil nil 0 0.01097 nil -0.99622 -0.75824 -0.43028 0 0.66553 1.56677 nil 0 -0.13979 nil 0 -0.19443 -0.03596 -0.19443 nil 0 0.09631 0.2109 nil 0 -0.10169 nil 0 -0.31226 nil 0 0.32677 nil 0.18723 0 nil nil nil nil nil)\n                    :level-name '(nil nil \"Male\" \"Female\" nil 18 - 29  30 - 39 40 - 49 50 - 59 60 - 69 70 + nil \"White\" \"Non-white\" nil \"O\" \"A\" \"B\" \"AB\" nil \"easy\" \"moderate\" \"difficult\" nil \"first\" \"re-graft\" nil \"Yes\" \"No\" nil \"No\" \"Yes\" nil \"No\" \"Yes\" nil nil nil nil nil)\n                    :beta-all-reasons '(nil nil 0 -0.10876 nil 0.3303 0.22041 0.09241 0 -0.03388 0.11484 nil 0 -0.09953 nil 0 0.57296 0.00578 0.57296 nil 0 -0.29547 -0.62205 nil 0 -0.32497 nil 0 0.11702 nil 0 -0.56793 nil 0 0.05058 nil nil nil nil nil)\n                    :type '(nil nil :radio nil nil :dropdown nil nil nil nil nil nil :radio nil nil :radio nil nil nil nil :dropdown nil nil nil :radio nil nil :radio nil nil :radio nil nil :radio nil nil nil nil nil nil)\n                    :sub-text '(nil nil \"Sex\" nil nil \"Age (years)\" nil nil nil nil nil nil nil nil nil nil nil nil nil nil \"match score 1-3\" \"match score 4-6\" \"match score 7-10\" nil \"No\" \"previous graft\" \"Replacing previous graft\" nil nil nil nil \"cRF less than 85%\" \"cRF 85% or more\" nil nil \"?\" nil nil nil nil nil)\n                    :level '(nil nil :male :female nil :18+ :30+ :40+ :50+ :60+ :70+ nil :white :non-white nil :O :A :B :AB nil :easy :moderate :difficult nil :first :re-graft nil :yes :no nil :no :yes nil :no :yes nil nil nil nil nil)\n                    :factor '(nil nil :sex :sex nil :age :age :age :age :age :age nil :ethnicity :ethnicity nil :blood-group :blood-group :blood-group :blood-group nil :matchability :matchability :matchability nil :graft :graft nil :dialysis :dialysis nil :sensitised :sensitised nil :diabetes :diabetes nil nil nil nil nil)\n                    :order '(nil nil 1 1 nil 1.2 1.2 1.2 1.2 1.2 1.2 nil 1.3 1.3 nil 1.4 1.4 1.4 1.4 nil 1.5 1.5 1.5 nil 1.6 1.6 nil 1.7 1.7 nil 1.8 1.8 nil 1.9 1.9 nil nil nil nil nil)\n                    :factor-name '(nil nil \"Sex\" nil nil \"Age (years)\" nil nil nil nil nil nil \"Ethnicity\" nil nil \"Blood group\" nil nil nil nil \"Matchability group\" nil nil nil \"Graft number\" nil nil \"Dialysis at registration?\" nil nil \"Highly sensitised?\" nil nil \"Primary renal disease - diabetes?\" nil nil nil nil nil nil)})\n  tool-inputs\n  \n  (def factor-rows\n    (->> tool-inputs\n         (map-of-vs->v-of-maps)\n         (filter :factor)\n         (sort-by :order)\n         (partition-by :factor)\n         ))\n  (first factor-rows)\n  (comment \n    ({:beta-transplant 0, :beta-death 0, :info-box? \"Male\", :beta-removal 0, :level-name \"Male\", :beta-all-reasons 0, :type :radio, :sub-text \"Sex\", :level :male, :factor :sex, :order 1, :factor-name \"Sex\"} \n     {:beta-transplant -0.06289, :beta-death -0.10852, :info-box? \"Female\", :beta-removal 0.01097, :level-name \"Female\", :beta-all-reasons -0.10876, :type nil, :sub-text nil, :level :female, :factor :sex, :order 1, :factor-name nil}))\n)\n  \n  \n\n"]}